CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE public.profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clerk_user_id TEXT UNIQUE NOT NULL,
    email TEXT,
    full_name TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.registrations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    full_name TEXT NOT NULL,
    registration_number TEXT NOT NULL,
    university_name TEXT NOT NULL,
    email TEXT NOT NULL,
    contact_number TEXT NOT NULL,
    course TEXT NOT NULL,
    year_of_study TEXT NOT NULL,
    event_type TEXT NOT NULL CHECK (event_type IN ('event', 'hackathon', 'both')),
    address TEXT NOT NULL,
    city TEXT NOT NULL,
    pincode TEXT NOT NULL,
    technical_skills TEXT,
    team_name TEXT,
    check_in_code TEXT UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.team_members (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    registration_id UUID REFERENCES public.registrations(id) ON DELETE CASCADE NOT NULL,
    member_type TEXT NOT NULL CHECK (member_type IN ('leader', 'member1', 'member2', 'member3')),
    name TEXT NOT NULL,
    registration_number TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.registrations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.team_members ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable all for profiles" ON public.profiles FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all for registrations" ON public.registrations FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all for team_members" ON public.team_members FOR ALL USING (true) WITH CHECK (true);

CREATE INDEX idx_profiles_clerk_user_id ON public.profiles(clerk_user_id);
CREATE INDEX idx_registrations_profile_id ON public.registrations(profile_id);
CREATE INDEX idx_registrations_check_in_code ON public.registrations(check_in_code);
CREATE INDEX idx_team_members_registration_id ON public.team_members(registration_id);
